# .htaccess SIN BUCLES DE REDIRECCIÓN
# Usa este si tienes problemas con ERR_TOO_MANY_REDIRECTS

RewriteEngine On

# REDIRECCIÓN HTTPS + WWW (en una sola regla para evitar bucles)
RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP_HOST} !^www\. [NC]
RewriteCond %{HTTP_HOST} ^(?:www\.)?(.+)$ [NC]
RewriteRule ^ https://www.%1%{REQUEST_URI} [L,R=301,NE]

# Prevenir listado de directorios
Options -Indexes

# Proteger archivos sensibles
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Compresión GZIP
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css text/javascript application/javascript application/x-javascript text/xml application/xml text/plain
</IfModule>

# Caché - Versión compatible con Magic Cache
<IfModule mod_headers.c>
    # Imágenes, videos, fuentes
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|avif|svg|ico|mp4|webm|woff|woff2|ttf|otf)$">
        Header set Cache-Control "max-age=2592000, public"
    </FilesMatch>
    
    # CSS y JS - Caché corta
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "max-age=300, public, must-revalidate"
    </FilesMatch>
    
    # HTML - Sin caché
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "max-age=0, must-revalidate"
    </FilesMatch>
</IfModule>

# Tipos MIME
<IfModule mod_mime.c>
    AddType image/webp .webp
    AddType image/avif .avif
    AddType font/woff2 .woff2
</IfModule>

# Seguridad
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
</IfModule>

# Charset
AddDefaultCharset UTF-8

# Error 404 personalizado
ErrorDocument 404 /404.html

